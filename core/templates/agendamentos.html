{% extends 'base.html' %}
{% block content %}
<h2 class="text-2xl font-bold mb-4">Agenda</h2>

<div id='calendar'></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const calendarEl = document.getElementById('calendar');
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'timeGridWeek,timeGridDay,dayGridMonth'
    },
    selectable: true,
    select: function(info) {
      const start = info.startStr;
      const end = info.endStr;
      const doctorId = prompt('Digite o ID do médico para agendar (veja lista abaixo):');
      if (!doctorId) return;
      fetch('{% url "api_appointments" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({doctor: parseInt(doctorId), start: start, end: end})
      }).then(res => {
        if (res.ok) { calendar.refetchEvents(); }
        else { res.text().then(t=>alert('Erro: '+t)); }
      });
    },
    events: function(fetchInfo, successCallback, failureCallback) {
      fetch('{% url "api_appointments" %}').then(r=>r.json()).then(data=>{
        const events = data.map(d=>({id:d.id, title:d.title, start:d.start, end:d.end}));
        successCallback(events);
      }).catch(e=>failureCallback(e));
    }
  });
  calendar.render();
});
</script>

<div class="mt-6">
  <h4 class="text-lg font-bold">Médicos (IDs)</h4>
  <ul>
    {% for m in doctors %}
      <li>{{ m.id }} — {{ m }}</li>
    {% endfor %}
  </ul>
</div>

{% endblock %}
